#!/bin/bash
# -*- mode: bash; tab-width: 2; -*-
# vim: ts=2 sw=2 ft=bash noet

# source the Nos framework
. /opt/nos/common.sh

# initialize Nos with the original arguments
nos_init $@

# source common lib
. ${engine_lib_dir}/common.sh

nos_print_process_start "Installing packages"

# install java runtime, if jruby is being used
java_install_runtime

# install ruby, jruby, or rubinius interpreters
ruby_install_runtime

# install bundler binary
ruby_install_bundler

# install node.js for static assets
nodejs_install_runtime

# install bower via npm if Bower.json is found
nodejs_install_bower

# install dependencies for services so native extensions can be compiled
ruby_install_dependencies

# inject thin, unicorn, or puma into Gemfile
ruby_inject_webserver

# persist all environment variables 
nos_persist_evars

# generate config files for thin, unicorn, or puma
ruby_configure_webserver

# run bundle install
ruby_bundle_install

# clean unused gems from the vendor
ruby_bundle_clean

# run bower install if Bower.json is found
nodejs_bower_install

# persist the current node.js version in the cache
nodejs_set_runtime

exit 0